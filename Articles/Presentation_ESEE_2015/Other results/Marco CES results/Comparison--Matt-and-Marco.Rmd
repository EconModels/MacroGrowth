---
title: "Comparison of Fitting Algorithms"
author: "MK Heun"
date: "17 June 2015"
output: pdf_document
---

```{r, echo=FALSE, include=FALSE}
require(EconData)
require(EconModels)
require(dplyr)
```

This document compares Marco's results to Matt's results
for fitting the CES model for Portugal, Without energy, and
with Unadjusted factors of production.

First, some setup code.

```{r setup}
formulas <- 
  list( 
    PT = c(unadjusted = build_formula("iGDP", list("iKstkS.L", "iL", "iXpMP", "iYear")),
             adjusted = build_formula("iGDP", list("iKservS.L", "ihLest", "iUMP", "iYear"))),
    UK = c(unadjusted = build_formula("iGDP", list("iKstkO.WwithRD", "iL", "iXp", "iYear")),
             adjusted = build_formula("iGDP", list("iKservO.WwithRD", "ihLest", "iU", "iYear")))
  )
historicalData <- list()
commonVars <- c("Year", "Country", "Source")
historicalData$PT <- filter(IST, Country == "PT") 
historicalData$PT <- historicalData$PT[ , unique(c(commonVars,
                                                   all.vars(formulas$PT$unadjusted), 
                                                   all.vars(formulas$PT$adjusted)))]
historicalData$UK <- filter(Leeds, Country == "UK")
historicalData$UK <- historicalData$UK[ , unique(c(commonVars,
                                                   all.vars(formulas$UK$unadjusted), 
                                                   all.vars(formulas$UK$adjusted)))]
# Remove energy to create the formula we'll use for fitting below
form <- keep_summands(formulas$PT$unadjusted, n = -3) 
form
```


# Additive Errors

Marco reports the following results from his CES fitter:

```{r Marcos results}
# Marco's coefficients for PT, CES, unadjusted, without energy
gamma_marco <- 1.0306
lambda_marco <- 0.0055
delta_1_marco <- 0.9844
rho_1_marco <- 3.4647
sse_marco <- 0.6625
```

I'll first try to reproduce Marco's results 
using additive errors, as opposed to multiplicative errors (`multErr = FALSE`),
with unconstrained fitting (`constrained = FALSE`) and
no boundary models (`fitBoundaries = FALSE`).
Setting `fitBoundaries = FALSE`
turns off boundary model fitting.
Setting `constrained = FALSE` turns off the typical constraints on parameters,
which are
$0 \le \gamma < \infty$, $0 \le \delta,\delta_1 \le 1$, and $-1 \le \rho,\rho_1 < \infty$.
Note that $\gamma$ is the pre-multiplier in the CES equation,
not the coefficient for energy.

```{r Reproduce Marcos results}
mod_unconstrained <- cesModel(form, data = historicalData$PT, multErr = FALSE,
                              constrained = FALSE, fitBoundaries = FALSE,
                              algorithms = "PORT")
naturalCoef(mod_unconstrained)
sum(resid(mod_unconstrained)^2)
```

Although these results are not *exactly* identical to Marco's,
they are very close.
Thus, I think we have found the assumptions that Marco's fitter used.
Furthermore, we have confirmed that our fitters produce (nearly) identical
results for models that assume additive errors and unconstrained fitting.

[//]: (Next, let's try a fit using additive errors using our algorithms
with our constrained fitting approach.)


```{r, eval=FALSE, include=FALSE}
mod_additive <- cesModel(form, data=historicalData$PT, multErr = FALSE,
                         constrained = TRUE, fitBoundaries = TRUE,
                         algorithms = "PORT")
naturalCoef(mod_additive)
sum(resid(mod_additive)^2)
```

[//]: (We are able to find a better fit, i.e., one with smaller *sse*.
Note that this "better" solution is on a boundary,
namely where `delta_1 = 1`.
Marco's fit is at `delta_1 = 0.9844`, close but not exactly on the boundary.)


# Multiplicative Errors 

We (at Calvin) usually fit using multiplicative errors as follows:

```{r}
# Fit using cesModel with multiplicative errors by setting multErr=TRUE (the default)
mod_mult <- cesModel(form, data=historicalData$PT, multErr = TRUE,
                     constrained = TRUE, fitBoundaries = TRUE)
naturalCoef(mod_mult)
sum(resid(mod_mult)^2)
```

Because the errors (and their assumed form) are an integral part of the model,
the fitted coefficients are a function of the type of errors assumed
(multiplicative or additive).
At this time, I don't have results from Marco's software
when fitting with multiplicative errors.
Thus, it is not possible to compare results 
when fitting assuming multiplicative.

Furthermore, it is inappropriate to try to calculate an `additive error sse` from the
multiplicative error model to compare against the `sse` from an additive error model.
When you switch from additive to multiplicative errors, 
the values of your fitted coefficients will necessarily change.
Calculating an additive `sse` from multiplicative coefficients is like comparing
apples to oranges.

The next step on this comparison process will be for Marco to run his fitter
using multiplicative errors, if that is possible.
After doing so, we can compare `sse` values and coefficients.
If things work as well for the multiplicative error models as for
the additive error models, we'll find the exact same results for both
Marco's and my multiplicative models.