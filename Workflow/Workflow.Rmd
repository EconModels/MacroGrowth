---
title: "Workflow"
author: "Matthew Kuperus Heun"
date: "6 August 2014"
output: html_document
---

This file contains information about the workflow for resampling analyses of a data source.

### Add new data
* Add a file that contains the historical data from `<Source>` (name should be `<Source>.txt`) 
in the `data` directory at the top level of the repository.   
* Add any Excel workbooks or other metadata in `data/Excel Workbooks/<Source>`.
* Add any new countries to the `countryAbbrevs` variable in `Packages/EconData/R/Constants.R`.

### Create historical data frame
* Run `Scripts/PreProcess.R -S <Sources>` to create the historical data frame for `<Sources>`.
Note that` <Sources>` can be a comma-separated list of sources.
The files will be stored at `Packages/EconData/data/<Source>.rda`.
This command is fast; it can be run on a local machine.    
* Build and reload the `EconData` package on a local machine.    
* Push the changes to GitHub.   
* In RStudio at http://rstudio-acc.calvin.edu, pull from GitHub to ensure that RStudio on `acc` will use the same code.
* Install the `EconData` package from GitHub to dahl
    + Log in to dahl.
    + Open an R shell by saying `R` at the command prompt.    
    + Say `require(devtools)`.
    + Say `install_github("MatthewHeun/Econ-Growth-R-Analysis/Packages/EconData")`.
    + While you're at it, you might want to install the `EconModels` package, too. Say 
        `install_github("MatthewHeun/Econ-Growth-R-Analysis/Packages/EconModels")`

`install_github` installs the packages into your home directory, which is available to all nodes of `dahl`.

### Create the batch script
* Create the file `Scripts/<Source>-torque.bash` file.
    + It is probably best to modify an existing `<Source>-torque.bash` file.      
    + Be sure to edit the `$SRC` variable.
* Push the `<Source>-torque.bash` file to GitHub.
* On http://rstudio-acc.calvin.edu, pull from GitHub.      

### Submit the job to dahl
* `cd` to the `Econ-Growth-R-Analysis` directory on `node-00` of `dahl`.
* Run `Scripts/<Source>-torque.bash "-n 2 -C -d"`. Sample status files will be saved in `Econ-Growth-R-Analysis`. (Would be nice to save these output files into `data_resample`.) Look at the status files to see that everything worked as expected.
* Run `Scripts/<Source>-torque.bash "-n 2 -C"` to test that things work as expected.
* Then do `Scripts/<Source>-torque.bash "-n 1000 -C"` to do a complete run.
* Check `dahl`'s status at http://dahl.calvin.edu/ganglia/.
* Check progress with commands such as `more JobF-CN-iU.e31170`, where `JobF-CN-iU.e31170` is the name of the process that you'd likt to check.

### Post-process the results
* Run `Scripts/PostProcess.R -S <Source>` on `node-00` of `dahl` to create:       
    + `data_postprocessed/<Source>_Coeffs.rds`,
    + `data_postprocessed/<Source>_Fitted.rds`, and  
    + `data_postprocessed/<Source>_oModels.rds`.
* `PostProcess.R` will accept multiple `<Source>`s. E.g., `Scripts/PostProcess.R -S IST,Leeds,SUN,REXS1960`

### Download post-processed results to local machine
* From the `Econ-Growth-R-Analysis` directory of a local machine, 
say `Scripts/DownloadPostProcessed.R -u <user> -S <Source> -d`, where `<user>` is 
a username on `dahl`, `<Source>` is a comma-separated list of data sources of interest, and `-d` (debug) will 
show the files to be transferred to the local machine, without actually transferring them.
* Verify that the list of files to be transferred looks right.
* From a local computer, say `Scripts/DownloadPostProcessed.R -u <user> -S <Source>` to download the files.
* The files are downloaded to the `data_postprocessed` directory on the local machine.
* Use the function `loadPostProcessedData` in the `EconData` package to load the downloaded data into
the environment. 

The data files are saved with `saveRDS` by `PostProcess.R`, so `loadPostProcessedData` uses `readRDS` to 
load the data into memory. 
As a consequence, `loadPostProcessedData` returns an object which must be assigned to a variable in `R`.

### 
* If Randy has run the analysis, resampling results can be placed in `/home/rpruim/Share`. 
* To download resampling results to his laptop, Matt can say, for example, `scp -P 22122 mkh2@dahl.calvin.edu:/home/rpruim/Share/2015-06-11-run/data_resample/Calvin/* ~/github/Econ-Growth-R-Analysis/data_resample/Calvin`
* Another way to run some of this is to say `qsub -N JobF-US -d `pwd` batchEcon.R -F "-c US -e all -f all -m fast -S Calvin -n 1000 -C"`